from __future__ import absolute_import, print_function, unicode_literals
import sys, logging, optparse
from lib2to3.main import main, warn, StdoutRefactoringTool
from lib2to3 import refactor
from future import __version__
from libpasteurize.fixes import fix_names

def main(args=None):
    parser = optparse.OptionParser(usage=b'pasteurize [options] file|dir ...')
    parser.add_option(b'-V', b'--version', action=b'store_true', help=b'Report the version number of pasteurize')
    parser.add_option(b'-a', b'--all-imports', action=b'store_true', help=b'Adds all __future__ and future imports to each module')
    parser.add_option(b'-f', b'--fix', action=b'append', default=[], help=b'Each FIX specifies a transformation; default: all')
    parser.add_option(b'-j', b'--processes', action=b'store', default=1, type=b'int', help=b'Run 2to3 concurrently')
    parser.add_option(b'-x', b'--nofix', action=b'append', default=[], help=b'Prevent a fixer from being run.')
    parser.add_option(b'-l', b'--list-fixes', action=b'store_true', help=b'List available transformations')
    parser.add_option(b'-v', b'--verbose', action=b'store_true', help=b'More verbose logging')
    parser.add_option(b'--no-diffs', action=b'store_true', help=b"Don't show diffs of the refactoring")
    parser.add_option(b'-w', b'--write', action=b'store_true', help=b'Write back modified files')
    parser.add_option(b'-n', b'--nobackups', action=b'store_true', default=False, help=b"Don't write backups for modified files.")
    refactor_stdin = False
    flags = {}
    options, args = parser.parse_args(args)
    fixer_pkg = b'libpasteurize.fixes'
    avail_fixes = fix_names
    flags[b'print_function'] = True
    if not options.write and options.no_diffs:
        warn(b"not writing files and not printing diffs; that's not very useful")
    if not options.write and options.nobackups:
        parser.error(b"Can't use -n without -w")
    if options.version:
        print(__version__)
        return 0
    else:
        if options.list_fixes:
            print(b'Available transformations for the -f/--fix option:')
            for fixname in sorted(avail_fixes):
                print(fixname)

            if not args:
                return 0
        if not args:
            print(b'At least one file or directory argument required.', file=sys.stderr)
            print(b'Use --help to show usage.', file=sys.stderr)
            return 2
        if b'-' in args:
            refactor_stdin = True
            if options.write:
                print(b"Can't write to stdin.", file=sys.stderr)
                return 2
        level = logging.DEBUG if options.verbose else logging.INFO
        logging.basicConfig(format=b'%(name)s: %(message)s', level=level)
        unwanted_fixes = set()
        for fix in options.nofix:
            if b'.fix_' in fix:
                unwanted_fixes.add(fix)
            else:
                found = [ f for f in avail_fixes if f.endswith((b'fix_{0}').format(fix))
                        ]
                if len(found) > 1:
                    print(b'Ambiguous fixer name. Choose a fully qualified module name instead from these:\n' + (b'\n').join(b'  ' + myf for myf in found), file=sys.stderr)
                    return 2
                if len(found) == 0:
                    print(b'Unknown fixer. Use --list-fixes or -l for a list.', file=sys.stderr)
                    return 2
                unwanted_fixes.add(found[0])

        extra_fixes = set()
        if options.all_imports:
            prefix = b'libpasteurize.fixes.'
            extra_fixes.add(prefix + b'fix_add_all__future__imports')
            extra_fixes.add(prefix + b'fix_add_future_standard_library_import')
            extra_fixes.add(prefix + b'fix_add_all_future_builtins')
        explicit = set()
        if options.fix:
            all_present = False
            for fix in options.fix:
                if fix == b'all':
                    all_present = True
                elif b'.fix_' in fix:
                    explicit.add(fix)
                else:
                    found = [ f for f in avail_fixes if f.endswith((b'fix_{0}').format(fix))
                            ]
                    if len(found) > 1:
                        print(b'Ambiguous fixer name. Choose a fully qualified module name instead from these:\n' + (b'\n').join(b'  ' + myf for myf in found), file=sys.stderr)
                        return 2
                    if len(found) == 0:
                        print(b'Unknown fixer. Use --list-fixes or -l for a list.', file=sys.stderr)
                        return 2
                    explicit.add(found[0])

            if len(explicit & unwanted_fixes) > 0:
                print(b'Conflicting usage: the following fixers have been simultaneously requested and disallowed:\n' + (b'\n').join(b'  ' + myf for myf in explicit & unwanted_fixes), file=sys.stderr)
                return 2
            requested = avail_fixes.union(explicit) if all_present else explicit
        else:
            requested = avail_fixes.union(explicit)
        fixer_names = requested | extra_fixes - unwanted_fixes
        rt = StdoutRefactoringTool(sorted(fixer_names), flags, set(), options.nobackups, not options.no_diffs)
        if not rt.errors:
            if refactor_stdin:
                rt.refactor_stdin()
            else:
                try:
                    rt.refactor(args, options.write, None, options.processes)
                except refactor.MultiprocessingUnsupported:
                    print(b"Sorry, -j isn't supported on this platform.", file=sys.stderr)
                    return 1

            rt.summarize()
        return int(bool(rt.errors))